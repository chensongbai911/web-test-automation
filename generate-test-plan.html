<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI æ™ºèƒ½æµ‹è¯•è®¡åˆ’ç”Ÿæˆå™¨</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #667eea;
        font-size: 32px;
        margin-bottom: 10px;
      }

      .header p {
        color: #666;
        font-size: 16px;
      }

      .content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .panel {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .panel h2 {
        color: #333;
        font-size: 24px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .icon {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 8px;
        font-size: 18px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        color: #555;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 120px;
        font-family: "Courier New", monospace;
      }

      .btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .loading {
        display: none;
        margin-top: 20px;
        text-align: center;
        color: #667eea;
        font-weight: 600;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .result {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        max-height: 600px;
        overflow-y: auto;
      }

      .result h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 18px;
      }

      .test-step {
        background: white;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .test-step .step-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .step-number {
        background: #667eea;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }

      .step-title {
        font-weight: 600;
        color: #333;
        flex: 1;
      }

      .priority-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .priority-high {
        background: #fee;
        color: #c00;
      }

      .priority-medium {
        background: #fef3cd;
        color: #856404;
      }

      .priority-low {
        background: #d4edda;
        color: #155724;
      }

      .step-details {
        color: #666;
        font-size: 14px;
        line-height: 1.6;
      }

      .step-details div {
        margin-bottom: 8px;
      }

      .step-details strong {
        color: #333;
      }

      .export-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .export-buttons button {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-download {
        background: #28a745;
        color: white;
      }

      .btn-copy {
        background: #17a2b8;
        color: white;
      }

      .btn-download:hover,
      .btn-copy:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .alert {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .alert.show {
        display: block;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .page-info {
        background: #e7f3ff;
        border-left: 4px solid #0066cc;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .page-info h4 {
        color: #0066cc;
        margin-bottom: 10px;
        font-size: 16px;
      }

      .page-info p {
        color: #666;
        font-size: 14px;
        margin: 5px 0;
      }

      .risk-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
      }

      .risk-warning h4 {
        color: #856404;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .risk-warning ul {
        margin-left: 20px;
        color: #666;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <script src="../src/enhanced-document-generator.js"></script>
    <div class="container">
      <div class="header">
        <h1>ğŸ¤– AI æ™ºèƒ½æµ‹è¯•è®¡åˆ’ç”Ÿæˆå™¨</h1>
        <p>
          åˆ©ç”¨ Qwen AI æ¨¡å‹è‡ªåŠ¨åˆ†æé¡µé¢å¹¶ç”Ÿæˆæœ€ä¼˜æµ‹è¯•ç­–ç•¥ -
          é¿å…é‡å¤æµ‹è¯•ï¼Œæé«˜æµ‹è¯•æ•ˆç‡
        </p>
      </div>

      <div class="content">
        <!-- å·¦ä¾§ï¼šè¾“å…¥é¢æ¿ -->
        <div class="panel">
          <h2><span class="icon">ğŸ“</span> é¡µé¢ä¿¡æ¯</h2>

          <div class="alert alert-success" id="successAlert"></div>
          <div class="alert alert-error" id="errorAlert"></div>

          <div class="form-group">
            <label>Qwen API Key</label>
            <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxx" />
          </div>

          <div class="form-group">
            <label>é¡µé¢ URL</label>
            <input
              type="url"
              id="pageUrl"
              placeholder="https://example.com/page"
            />
          </div>

          <div class="form-group">
            <label>é¡µé¢æ ‡é¢˜</label>
            <input type="text" id="pageTitle" placeholder="ç³»ç»Ÿè§„åˆ™ç®¡ç†" />
          </div>

          <div class="form-group">
            <label>é¡µé¢ç±»å‹</label>
            <select id="pageType">
              <option value="auto">è‡ªåŠ¨è¯†åˆ«</option>
              <option value="form">è¡¨å•æäº¤é¡µé¢</option>
              <option value="list">åˆ—è¡¨ç®¡ç†é¡µé¢</option>
              <option value="dashboard">æ•°æ®ä»ªè¡¨ç›˜</option>
              <option value="workflow">å®¡æ‰¹æµç¨‹é¡µé¢</option>
              <option value="search">æŸ¥è¯¢æ£€ç´¢é¡µé¢</option>
            </select>
          </div>

          <div class="form-group">
            <label>é¡µé¢å…ƒç´ ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰</label>
            <textarea
              id="pageElements"
              placeholder='{"forms": 1, "buttons": 5, "inputs": 8, "selects": 3}'
            ></textarea>
          </div>

          <div class="form-group">
            <label>æµ‹è¯•é‡ç‚¹</label>
            <textarea
              id="testFocus"
              placeholder="éœ€è¦é‡ç‚¹æµ‹è¯•çš„åŠŸèƒ½ï¼Œå¦‚ï¼šè¡¨å•éªŒè¯ã€æ•°æ®ä¿å­˜ã€æƒé™æ§åˆ¶ç­‰"
            ></textarea>
          </div>

          <button class="btn" id="generateBtn">
            <span>ğŸš€</span>
            <span>ç”Ÿæˆæ™ºèƒ½æµ‹è¯•è®¡åˆ’</span>
          </button>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>AI æ­£åœ¨åˆ†æé¡µé¢å¹¶ç”Ÿæˆæµ‹è¯•ç­–ç•¥...</p>
          </div>
        </div>

        <!-- å³ä¾§ï¼šç»“æœé¢æ¿ -->
        <div class="panel">
          <h2><span class="icon">ğŸ“Š</span> æµ‹è¯•è®¡åˆ’</h2>
          <div class="result" id="result">
            <div style="text-align: center; color: #999; padding: 60px 20px">
              <div style="font-size: 48px; margin-bottom: 20px">ğŸ“‹</div>
              <p>è¯·å¡«å†™å·¦ä¾§ä¿¡æ¯åç‚¹å‡»"ç”Ÿæˆæ™ºèƒ½æµ‹è¯•è®¡åˆ’"</p>
            </div>
          </div>

          <div class="export-buttons" id="exportButtons" style="display: none">
            <button class="btn-download" id="downloadBtn">
              ğŸ“¥ ä¸‹è½½æµ‹è¯•æ–‡æ¡£
            </button>
            <button class="btn-copy" id="copyBtn">ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
          </div>
        </div>
      </div>
    </div>

    <script src="qwen-integration.js"></script>
    <script>
      let testPlanData = null;
      let qwen = null;

      // åŠ è½½ä¿å­˜çš„ API Key
      chrome.storage.local.get(["qwenApiKey"], (result) => {
        if (result.qwenApiKey) {
          document.getElementById("apiKey").value = result.qwenApiKey;
        }
      });

      // ä»å½“å‰æ ‡ç­¾é¡µè·å–ä¿¡æ¯
      chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
        if (tabs[0]) {
          document.getElementById("pageUrl").value = tabs[0].url;
          document.getElementById("pageTitle").value = tabs[0].title;
        }
      });

      // ç”Ÿæˆæµ‹è¯•è®¡åˆ’
      document
        .getElementById("generateBtn")
        .addEventListener("click", async () => {
          const apiKey = document.getElementById("apiKey").value.trim();
          const pageUrl = document.getElementById("pageUrl").value.trim();
          const pageTitle = document.getElementById("pageTitle").value.trim();
          const pageType = document.getElementById("pageType").value;
          const pageElements = document
            .getElementById("pageElements")
            .value.trim();
          const testFocus = document.getElementById("testFocus").value.trim();

          if (!apiKey) {
            showAlert("è¯·è¾“å…¥ Qwen API Key", "error");
            return;
          }

          if (!pageUrl || !pageTitle) {
            showAlert("è¯·å¡«å†™é¡µé¢ URL å’Œæ ‡é¢˜", "error");
            return;
          }

          // åˆå§‹åŒ– Qwen
          if (!qwen) {
            qwen = new QwenIntegration(apiKey);
          }

          // è§£æé¡µé¢å…ƒç´ 
          let elementsData = {};
          if (pageElements) {
            try {
              elementsData = JSON.parse(pageElements);
            } catch (e) {
              showAlert("é¡µé¢å…ƒç´  JSON æ ¼å¼é”™è¯¯", "error");
              return;
            }
          }

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          document.getElementById("generateBtn").disabled = true;
          document.getElementById("loading").classList.add("active");
          document.getElementById("result").innerHTML =
            '<div style="text-align: center; color: #999; padding: 40px;"><p>AI åˆ†æä¸­...</p></div>';

          try {
            const prompt = `ä½ æ˜¯èµ„æ·±çš„è‡ªåŠ¨åŒ–æµ‹è¯•ä¸“å®¶ã€‚è¯·ä¸ºä»¥ä¸‹é¡µé¢ç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•è®¡åˆ’ã€‚

**é¡µé¢ä¿¡æ¯ï¼š**
- URL: ${pageUrl}
- æ ‡é¢˜: ${pageTitle}
- é¡µé¢ç±»å‹: ${pageType === "auto" ? "è¯·è‡ªåŠ¨è¯†åˆ«" : pageType}
- é¡µé¢å…ƒç´ : ${JSON.stringify(elementsData)}
- æµ‹è¯•é‡ç‚¹: ${testFocus || "å…¨é¢æµ‹è¯•"}

**è¦æ±‚ï¼š**
1. åˆ†æé¡µé¢çš„ä¸šåŠ¡åœºæ™¯å’ŒåŠŸèƒ½ç±»å‹
2. ç”Ÿæˆç»“æ„åŒ–çš„æµ‹è¯•æ­¥éª¤ï¼ˆä¸è¦é‡å¤æµ‹è¯•ç›¸åŒåŠŸèƒ½ï¼‰
3. ä¸ºæ¯ä¸ªæ­¥éª¤æ ‡æ³¨ä¼˜å…ˆçº§å’Œé£é™©ç­‰çº§
4. æä¾›æ•°æ®å‡†å¤‡å»ºè®®å’Œé¢„æœŸç»“æœ
5. è¯†åˆ«æ½œåœ¨çš„æµ‹è¯•éš¾ç‚¹å’Œé£é™©

**å¿…é¡»æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼ˆåªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ï¼‰ï¼š**
{
  "pageAnalysis": {
    "pageType": "è¯†åˆ«çš„é¡µé¢ç±»å‹",
    "businessScenario": "ä¸šåŠ¡åœºæ™¯æè¿°",
    "complexity": "simple/moderate/complex",
    "estimatedTime": "é¢„è®¡æµ‹è¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰"
  },
  "testSteps": [
    {
      "stepId": 1,
      "action": "æ“ä½œç±»å‹ï¼ˆå¦‚ï¼šå¡«å†™è¡¨å•/ç‚¹å‡»æŒ‰é’®/é€‰æ‹©ä¸‹æ‹‰ç­‰ï¼‰",
      "target": "ç›®æ ‡å…ƒç´ æè¿°",
      "selector": "å»ºè®®çš„CSSé€‰æ‹©å™¨",
      "testData": "æµ‹è¯•æ•°æ®ç¤ºä¾‹",
      "priority": "high/medium/low",
      "riskLevel": "high/medium/low",
      "expectedResult": "é¢„æœŸç»“æœ",
      "validationPoints": ["éªŒè¯ç‚¹1", "éªŒè¯ç‚¹2"],
      "notes": "æ³¨æ„äº‹é¡¹"
    }
  ],
  "dataPreparation": {
    "requiredData": ["éœ€è¦å‡†å¤‡çš„æ•°æ®ç±»å‹"],
    "mockData": {
      "å­—æ®µå": "æµ‹è¯•æ•°æ®ç¤ºä¾‹"
    }
  },
  "potentialRisks": [
    {
      "risk": "é£é™©æè¿°",
      "likelihood": "high/medium/low",
      "mitigation": "ç¼“è§£æªæ–½"
    }
  ],
  "testingGuidelines": [
    "æµ‹è¯•æŒ‡å—1",
    "æµ‹è¯•æŒ‡å—2"
  ]
}`;

            const response = await qwen.request(
              [
                {
                  role: "user",
                  content: prompt,
                },
              ],
              {
                temperature: 0.3,
                max_tokens: 4000,
              }
            );

            // è§£æ AI å“åº”
            testPlanData = parseAIResponse(response);

            if (testPlanData) {
              renderTestPlan(testPlanData);
              showAlert("âœ… æµ‹è¯•è®¡åˆ’ç”ŸæˆæˆåŠŸï¼", "success");
              document.getElementById("exportButtons").style.display = "flex";
            } else {
              throw new Error("AI è¿”å›æ ¼å¼é”™è¯¯");
            }
          } catch (error) {
            console.error("ç”Ÿæˆå¤±è´¥:", error);
            showAlert("ç”Ÿæˆå¤±è´¥: " + error.message, "error");
            document.getElementById("result").innerHTML = `
          <div style="text-align: center; color: #c00; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 20px;">âŒ</div>
            <p>ç”Ÿæˆå¤±è´¥: ${error.message}</p>
          </div>
        `;
          } finally {
            document.getElementById("generateBtn").disabled = false;
            document.getElementById("loading").classList.remove("active");
          }
        });

      // è§£æ AI å“åº”
      function parseAIResponse(response) {
        try {
          // æå– JSON
          let content = response.trim();

          // ç§»é™¤å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
          content = content.replace(/```json\n?/g, "").replace(/```\n?/g, "");

          // æŸ¥æ‰¾ JSON å¯¹è±¡
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            return JSON.parse(jsonMatch[0]);
          }

          return JSON.parse(content);
        } catch (e) {
          console.error("è§£æ AI å“åº”å¤±è´¥:", e, response);
          return null;
        }
      }

      // æ¸²æŸ“æµ‹è¯•è®¡åˆ’
      function renderTestPlan(plan) {
        const resultDiv = document.getElementById("result");

        let html = "";

        // é¡µé¢åˆ†æ
        if (plan.pageAnalysis) {
          html += `
          <div class="page-info">
            <h4>ğŸ“Š é¡µé¢åˆ†æ</h4>
            <p><strong>é¡µé¢ç±»å‹ï¼š</strong>${
              plan.pageAnalysis.pageType || "æœªçŸ¥"
            }</p>
            <p><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong>${
              plan.pageAnalysis.businessScenario || "æœªçŸ¥"
            }</p>
            <p><strong>å¤æ‚åº¦ï¼š</strong>${
              plan.pageAnalysis.complexity || "moderate"
            }</p>
            <p><strong>é¢„è®¡æ—¶é•¿ï¼š</strong>${
              plan.pageAnalysis.estimatedTime || "5-10"
            } åˆ†é’Ÿ</p>
          </div>
        `;
        }

        // æµ‹è¯•æ­¥éª¤
        html += "<h3>ğŸ¯ æµ‹è¯•æ­¥éª¤</h3>";

        if (plan.testSteps && plan.testSteps.length > 0) {
          plan.testSteps.forEach((step) => {
            const priorityClass = `priority-${step.priority || "medium"}`;
            const priorityText = {
              high: "é«˜ä¼˜å…ˆçº§",
              medium: "ä¸­ä¼˜å…ˆçº§",
              low: "ä½ä¼˜å…ˆçº§",
            }[step.priority || "medium"];

            html += `
            <div class="test-step">
              <div class="step-header">
                <div class="step-number">${step.stepId}</div>
                <div class="step-title">${step.action}</div>
                <span class="priority-badge ${priorityClass}">${priorityText}</span>
              </div>
              <div class="step-details">
                <div><strong>ç›®æ ‡ï¼š</strong>${step.target}</div>
                ${
                  step.selector
                    ? `<div><strong>é€‰æ‹©å™¨ï¼š</strong><code>${step.selector}</code></div>`
                    : ""
                }
                ${
                  step.testData
                    ? `<div><strong>æµ‹è¯•æ•°æ®ï¼š</strong>${step.testData}</div>`
                    : ""
                }
                <div><strong>é¢„æœŸç»“æœï¼š</strong>${step.expectedResult}</div>
                ${
                  step.validationPoints && step.validationPoints.length > 0
                    ? `
                  <div><strong>éªŒè¯ç‚¹ï¼š</strong>
                    <ul style="margin: 5px 0 0 20px;">
                      ${step.validationPoints
                        .map((v) => `<li>${v}</li>`)
                        .join("")}
                    </ul>
                  </div>
                `
                    : ""
                }
                ${
                  step.notes
                    ? `<div><strong>æ³¨æ„ï¼š</strong>${step.notes}</div>`
                    : ""
                }
              </div>
            </div>
          `;
          });
        }

        // æ•°æ®å‡†å¤‡
        if (plan.dataPreparation) {
          html += `
          <div style="background: #f0f8ff; border-left: 4px solid #0066cc; padding: 15px; border-radius: 6px; margin-top: 15px;">
            <h4 style="color: #0066cc; margin-bottom: 10px; font-size: 14px;">ğŸ“¦ æ•°æ®å‡†å¤‡</h4>
            ${
              plan.dataPreparation.requiredData
                ? `
              <p style="margin: 5px 0;"><strong>éœ€è¦æ•°æ®ï¼š</strong>${plan.dataPreparation.requiredData.join(
                ", "
              )}</p>
            `
                : ""
            }
            ${
              plan.dataPreparation.mockData
                ? `
              <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px; overflow-x: auto;">${JSON.stringify(
                plan.dataPreparation.mockData,
                null,
                2
              )}</pre>
            `
                : ""
            }
          </div>
        `;
        }

        // æ½œåœ¨é£é™©
        if (plan.potentialRisks && plan.potentialRisks.length > 0) {
          html += `
          <div class="risk-warning">
            <h4>âš ï¸ æ½œåœ¨é£é™©</h4>
            <ul>
              ${plan.potentialRisks
                .map(
                  (risk) => `
                <li><strong>${risk.risk}</strong> - ${risk.mitigation}</li>
              `
                )
                .join("")}
            </ul>
          </div>
        `;
        }

        // æµ‹è¯•æŒ‡å—
        if (plan.testingGuidelines && plan.testingGuidelines.length > 0) {
          html += `
          <div style="background: #f0fff0; border-left: 4px solid #28a745; padding: 15px; border-radius: 6px; margin-top: 15px;">
            <h4 style="color: #28a745; margin-bottom: 10px; font-size: 14px;">ğŸ’¡ æµ‹è¯•æŒ‡å—</h4>
            <ul style="margin-left: 20px; color: #666; font-size: 13px;">
              ${plan.testingGuidelines.map((g) => `<li>${g}</li>`).join("")}
            </ul>
          </div>
        `;
        }

        resultDiv.innerHTML = html;
      }

      // ä¸‹è½½æµ‹è¯•æ–‡æ¡£ - æ”¯æŒå¤šç§æ ¼å¼
      document.getElementById("downloadBtn").addEventListener("click", () => {
        if (!testPlanData) return;

        // åˆ›å»ºæ ¼å¼é€‰æ‹©èœå•
        const formats = ['markdown', 'html', 'csv', 'json'];
        const selectedFormat = prompt(
          'è¯·é€‰æ‹©ä¸‹è½½æ ¼å¼:\\n1. Markdown (é»˜è®¤)\\n2. HTML\\n3. CSV (Excel)\\n4. JSON\\n\\nè¯·è¾“å…¥æ•°å­— (1-4):',
          '1'
        );

        const formatMap = { '1': 'markdown', '2': 'html', '3': 'csv', '4': 'json' };
        const format = formatMap[selectedFormat] || 'markdown';

        try {
          docGenerator.exportFile(testPlanData, format);
          showAlert(`âœ… ${format.toUpperCase()} æ–‡æ¡£å·²ä¸‹è½½`, 'success');

          // ä¿å­˜åˆ°å†å²è®°å½•
          docGenerator.saveToHistory(testPlanData);
        } catch (error) {
          showAlert(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
        }
      });

      // å¤åˆ¶åˆ°å‰ªè´´æ¿ - æ”¯æŒå¤šç§æ ¼å¼
      document.getElementById("copyBtn").addEventListener("click", () => {
        if (!testPlanData) return;

        const markdown = docGenerator.toMarkdown(testPlanData);
        navigator.clipboard.writeText(markdown).then(() => {
          showAlert("âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (Markdownæ ¼å¼)", "success");
        }).catch(error => {
          showAlert(`âŒ å¤åˆ¶å¤±è´¥: ${error.message}`, "error");
        });
      });

      // ç”Ÿæˆ Markdown æ–‡æ¡£
      // ç”Ÿæˆ Markdown æ–‡æ¡£ï¼ˆå·²ç”± EnhancedDocumentGenerator æä¾›ï¼‰
      // æ­¤å‡½æ•°å·²å¼ƒç”¨ï¼Œä½¿ç”¨ docGenerator.toMarkdown(testPlanData) ä»£æ›¿
      function generateMarkdown(plan) {
        return docGenerator.toMarkdown(plan);
      }

      // æ˜¾ç¤ºæç¤º
      function showAlert(message, type) {
        const successAlert = document.getElementById("successAlert");
        const errorAlert = document.getElementById("errorAlert");

        successAlert.classList.remove("show");
        errorAlert.classList.remove("show");

        if (type === "success") {
          successAlert.textContent = message;
          successAlert.classList.add("show");
          setTimeout(() => successAlert.classList.remove("show"), 3000);
        } else {
          errorAlert.textContent = message;
          errorAlert.classList.add("show");
          setTimeout(() => errorAlert.classList.remove("show"), 5000);
        }
      }
    </script>
  </body>
</html>
